#!/usr/bin/env ruby

require 'rubygems'
require 'yaml'
gem 'rails', '<3'
require 'active_record'
require 'action_mailer'
require 'fileutils'

FileUtils.chdir("#{File.dirname($0[0..0] == '/' ? $0 : "#{FileUtils.pwd}/#{$0}")}/..") do
  require 'lib/dcc_worker'

  config = YAML::load(File.read('config/worker.yml')).symbolize_keys
  ActiveRecord::Base.establish_connection(
      YAML::load(File.read('config/database.yml'))[config[:environment]])

  ActionMailer::Base.delivery_method = :sendmail

  DCCWorker.new(config[:group_name], config[:memcache_servers], config).run
end
